<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ClaudGrid Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: #0d1117;
      color: #e6edf3;
      font-family: 'Segoe UI', system-ui, monospace;
      font-size: 14px;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* ── Header ── */
    header {
      background: #161b22;
      border-bottom: 1px solid #30363d;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
    }
    header h1 { font-size: 17px; color: #58a6ff; letter-spacing: 0.5px; }

    #status-badge {
      padding: 2px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
    }
    .badge-running  { background: #1a4731; color: #3fb950; }
    .badge-stopped  { background: #3d1a1a; color: #f85149; }
    .badge-offline  { background: #2d2d00; color: #d29922; }

    #header-sync { margin-left: auto; font-size: 11px; color: #8b949e; }

    /* ── Stats strip ── */
    .stats-strip {
      display: flex;
      background: #30363d;
      gap: 1px;
      flex-shrink: 0;
    }
    .stat {
      flex: 1 1 120px;
      background: #161b22;
      padding: 10px 16px;
    }
    .stat-label {
      font-size: 10px;
      color: #8b949e;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 3px;
    }
    .stat-value {
      font-size: 18px;
      font-weight: 600;
    }
    .pos { color: #3fb950; }
    .neg { color: #f85149; }

    /* ── Charts ── */
    .charts-row {
      display: flex;
      gap: 1px;
      background: #30363d;
      flex-shrink: 0;
    }
    .chart-box {
      flex: 1;
      background: #161b22;
      padding: 14px 16px;
      height: 220px;
    }
    .chart-title {
      font-size: 11px;
      color: #8b949e;
      text-transform: uppercase;
      margin-bottom: 8px;
    }
    .chart-box canvas { width: 100% !important; height: calc(100% - 24px) !important; }

    /* ── Tables ── */
    .tables-row {
      display: flex;
      gap: 1px;
      background: #30363d;
      flex: 1;
      min-height: 0;
    }
    .table-box {
      flex: 1;
      background: #161b22;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .table-box h3 {
      font-size: 11px;
      color: #8b949e;
      text-transform: uppercase;
      padding: 10px 14px 6px;
      border-bottom: 1px solid #21262d;
      flex-shrink: 0;
    }
    .table-scroll {
      overflow-y: auto;
      flex: 1;
    }
    table { width: 100%; border-collapse: collapse; }
    th {
      position: sticky;
      top: 0;
      background: #161b22;
      text-align: left;
      padding: 6px 10px;
      font-size: 10px;
      color: #8b949e;
      font-weight: normal;
      border-bottom: 1px solid #30363d;
    }
    td {
      padding: 4px 10px;
      font-size: 12px;
      border-bottom: 1px solid #1a1f27;
    }
    .empty-row td { color: #8b949e; text-align: center; padding: 18px; }

    .s-active    { color: #58a6ff; }
    .s-filled    { color: #3fb950; }
    .s-pending   { color: #d29922; }
    .s-cancelled { color: #6e7681; }
    .side-buy    { color: #3fb950; }
    .side-sell   { color: #f85149; }

    /* ── Footer ── */
    footer {
      background: #161b22;
      border-top: 1px solid #30363d;
      padding: 5px 18px;
      font-size: 10px;
      color: #6e7681;
      flex-shrink: 0;
    }
  </style>
</head>
<body>

<header>
  <h1>ClaudGrid</h1>
  <span id="status-badge" class="badge-offline">OFFLINE</span>
  <span id="header-sync">—</span>
</header>

<div class="stats-strip">
  <div class="stat"><div class="stat-label">BTC Price</div><div class="stat-value" id="s-price">—</div></div>
  <div class="stat"><div class="stat-label">Total Equity</div><div class="stat-value" id="s-equity">—</div></div>
  <div class="stat"><div class="stat-label">Available</div><div class="stat-value" id="s-avail">—</div></div>
  <div class="stat"><div class="stat-label">Realized PnL</div><div class="stat-value" id="s-pnl">—</div></div>
  <div class="stat"><div class="stat-label">Active Orders</div><div class="stat-value" id="s-active">—</div></div>
  <div class="stat"><div class="stat-label">Fills</div><div class="stat-value" id="s-fills">—</div></div>
  <div class="stat"><div class="stat-label">Syncs</div><div class="stat-value" id="s-syncs">—</div></div>
</div>

<div class="charts-row">
  <div class="chart-box">
    <div class="chart-title">BTC Price (USDC)</div>
    <canvas id="price-chart"></canvas>
  </div>
  <div class="chart-box">
    <div class="chart-title">Realized PnL (USDC)</div>
    <canvas id="pnl-chart"></canvas>
  </div>
</div>

<div class="tables-row">
  <div class="table-box">
    <h3>Grid Levels</h3>
    <div class="table-scroll">
      <table>
        <thead>
          <tr><th>#</th><th>Side</th><th>Price</th><th>Size</th><th>Status</th><th>PnL</th></tr>
        </thead>
        <tbody id="levels-body">
          <tr class="empty-row"><td colspan="6">Waiting for data…</td></tr>
        </tbody>
      </table>
    </div>
  </div>
  <div class="table-box">
    <h3>Recent Fills</h3>
    <div class="table-scroll">
      <table>
        <thead>
          <tr><th>Time</th><th>Side</th><th>Price</th><th>Size</th><th>PnL</th></tr>
        </thead>
        <tbody id="fills-body">
          <tr class="empty-row"><td colspan="5">No fills yet</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<footer id="footer">Last updated: —</footer>

<script>
  // ── Chart helpers ──────────────────────────────────────────────────────────

  function makeChart(id, color, fill) {
    const ctx = document.getElementById(id);
    return new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          data: [],
          borderColor: color,
          borderWidth: 1.5,
          fill: fill,
          backgroundColor: fill ? color.replace(')', ', 0.08)').replace('rgb', 'rgba') : false,
          tension: 0,
          pointRadius: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: false,
        plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } },
        scales: {
          x: { display: false },
          y: {
            grid: { color: '#21262d' },
            ticks: { color: '#8b949e', font: { size: 10 }, maxTicksLimit: 5 }
          }
        }
      }
    });
  }

  const priceChart = makeChart('price-chart', 'rgb(88, 166, 255)', false);
  const pnlChart   = makeChart('pnl-chart',   'rgb(63, 185, 80)',  true);

  // ── Formatting helpers ─────────────────────────────────────────────────────

  const fmt  = (n, d = 2) => n == null ? '—' : (+n).toFixed(d);
  const fmtK = (n) => n == null ? '—' : '$' + (+n).toLocaleString('en-US', { maximumFractionDigits: 0 });
  const fmtT = (iso) => iso ? new Date(iso).toLocaleTimeString() : '—';
  const pnlCls = (v) => (+v) >= 0 ? 'pos' : 'neg';
  const sideCls = (s) => 'side-' + s.toLowerCase();
  const statusCls = (s) => 's-' + s.toLowerCase();

  // ── DOM update ─────────────────────────────────────────────────────────────

  function setText(id, val) { document.getElementById(id).textContent = val; }

  function updateStats(d) {
    const badge = document.getElementById('status-badge');
    badge.textContent = d.isRunning ? 'RUNNING' : 'STOPPED';
    badge.className = d.isRunning ? 'badge-running' : 'badge-stopped';
    setText('header-sync', 'Sync #' + d.syncCount);

    setText('s-price',  fmtK(d.midPrice));
    setText('s-equity', '$' + fmt(d.totalEquity));
    setText('s-avail',  '$' + fmt(d.availableBalance));

    const pnlEl = document.getElementById('s-pnl');
    pnlEl.textContent = fmt(d.realizedPnl, 4) + ' USDC';
    pnlEl.className = 'stat-value ' + pnlCls(d.realizedPnl);

    setText('s-active', d.activeOrders);
    setText('s-fills',  d.filledLevels);
    setText('s-syncs',  d.syncCount);
  }

  function updateCharts(d) {
    const ph = d.priceHistory || [];
    priceChart.data.labels = ph.map(p => fmtT(p.time));
    priceChart.data.datasets[0].data = ph.map(p => p.price);
    priceChart.update('none');

    const pnh = d.pnlHistory || [];
    const lastPnl = pnh.length ? pnh[pnh.length - 1].pnl : 0;
    const pnlColor = lastPnl >= 0 ? 'rgb(63, 185, 80)' : 'rgb(248, 81, 73)';
    pnlChart.data.labels = pnh.map(p => fmtT(p.time));
    pnlChart.data.datasets[0].data = pnh.map(p => p.pnl);
    pnlChart.data.datasets[0].borderColor = pnlColor;
    pnlChart.data.datasets[0].backgroundColor = pnlColor.replace(')', ', 0.08)').replace('rgb', 'rgba');
    pnlChart.update('none');
  }

  function updateLevels(levels) {
    const tbody = document.getElementById('levels-body');
    if (!levels || !levels.length) {
      tbody.innerHTML = '<tr class="empty-row"><td colspan="6">No levels</td></tr>';
      return;
    }
    const sorted = [...levels].sort((a, b) => b.price - a.price);
    tbody.innerHTML = sorted.map(l => `
      <tr>
        <td>${l.index}</td>
        <td class="${sideCls(l.side)}">${l.side}</td>
        <td>${fmtK(l.price)}</td>
        <td>${fmt(l.size, 4)}</td>
        <td class="${statusCls(l.status)}">${l.status}</td>
        <td class="${pnlCls(l.pnl)}">${fmt(l.pnl, 4)}</td>
      </tr>`).join('');
  }

  function updateFills(fills) {
    const tbody = document.getElementById('fills-body');
    if (!fills || !fills.length) {
      tbody.innerHTML = '<tr class="empty-row"><td colspan="5">No fills yet</td></tr>';
      return;
    }
    tbody.innerHTML = fills.map(f => `
      <tr>
        <td>${fmtT(f.time)}</td>
        <td class="${sideCls(f.side)}">${f.side}</td>
        <td>${fmtK(f.price)}</td>
        <td>${fmt(f.size, 4)}</td>
        <td class="${pnlCls(f.pnl)}">${fmt(f.pnl, 4)}</td>
      </tr>`).join('');
  }

  // ── Polling ────────────────────────────────────────────────────────────────

  async function poll() {
    try {
      const resp = await fetch('/api/status');
      if (!resp.ok) throw new Error(resp.statusText);
      const data = await resp.json();

      updateStats(data);
      updateCharts(data);
      updateLevels(data.levels);
      updateFills(data.recentFills);

      document.getElementById('footer').textContent =
        'Last updated: ' + new Date().toLocaleTimeString();
    } catch (e) {
      const badge = document.getElementById('status-badge');
      badge.textContent = 'OFFLINE';
      badge.className = 'badge-offline';
      console.error('Poll error:', e);
    }
  }

  poll();
  setInterval(poll, 3000);
</script>
</body>
</html>
